import"@abraham/reflection";import{singleton as e,container as t}from"tsyringe";import{emitServer as r,offServer as n,onServer as i,onceServer as o,emit as s,showCursor as c,WebView as u,setMsPerGameMinute as a}from"alt-client";import{BaseEventService as h,FrameworkEvent as l,StringResolver as b,Cast as p,castToString as d,JsonEntityModel as f,UtilsService as y,LoggerService as v,castToNumber as S,LoaderService as w,ValidateOptionsModel as _,validateEventExistsAndPush as m}from"@abstractflo/shared";function __decorate(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}function __metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}let E=class EventService extends h{emitServer(e,...t){r(e,...t)}offServer(e,t){n(e,t)}onServer(e,t){i(e,t)}onceServer(e,t){o(e,t)}onGui(e,t){s(l.EventService.GuiOn,e,t)}listenHandlerForType(e,t){this.on(e,((...r)=>{const n=r.shift();switch(!0){case["syncedMetaChange","streamSyncedMetaChange","gameEntityCreate","gameEntityDestroy"].includes(e):this.handleMetaChangeMethods(n,n.type,t,...r)}}))}};E=__decorate([b,e()],E);class WebviewEventModel extends f{}__decorate([p({from:d()}),__metadata("design:type",String)],WebviewEventModel.prototype,"eventName",void 0),__decorate([p({from:d()}),__metadata("design:type",String)],WebviewEventModel.prototype,"targetName",void 0),__decorate([p({from:d()}),__metadata("design:type",String)],WebviewEventModel.prototype,"methodName",void 0);var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function __extends(e,t){function __(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}function isFunction(e){return"function"==typeof e}var g=!1,x={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack;g=e},get useDeprecatedSynchronousErrorHandling(){return g}};function hostReportError(e){setTimeout((function(){throw e}),0)}var O={closed:!0,next:function(e){},error:function(e){if(x.useDeprecatedSynchronousErrorHandling)throw e;hostReportError(e)},complete:function(){}},A=function(){return Array.isArray||function(e){return e&&"number"==typeof e.length}}();var T=function(){function UnsubscriptionErrorImpl(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}return UnsubscriptionErrorImpl.prototype=Object.create(Error.prototype),UnsubscriptionErrorImpl}(),j=function(){function Subscription(e){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,e&&(this._ctorUnsubscribe=!0,this._unsubscribe=e)}return Subscription.prototype.unsubscribe=function(){var e;if(!this.closed){var t,r=this,n=r._parentOrParents,i=r._ctorUnsubscribe,o=r._unsubscribe,s=r._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,n instanceof Subscription)n.remove(this);else if(null!==n)for(var c=0;c<n.length;++c){n[c].remove(this)}if(isFunction(o)){i&&(this._unsubscribe=void 0);try{o.call(this)}catch(t){e=t instanceof T?flattenUnsubscriptionErrors(t.errors):[t]}}if(A(s)){c=-1;for(var u=s.length;++c<u;){var a=s[c];if(null!==(t=a)&&"object"==typeof t)try{a.unsubscribe()}catch(t){e=e||[],t instanceof T?e=e.concat(flattenUnsubscriptionErrors(t.errors)):e.push(t)}}}if(e)throw new T(e)}},Subscription.prototype.add=function(e){var t=e;if(!e)return Subscription.EMPTY;switch(typeof e){case"function":t=new Subscription(e);case"object":if(t===this||t.closed||"function"!=typeof t.unsubscribe)return t;if(this.closed)return t.unsubscribe(),t;if(!(t instanceof Subscription)){var r=t;(t=new Subscription)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}var n=t._parentOrParents;if(null===n)t._parentOrParents=this;else if(n instanceof Subscription){if(n===this)return t;t._parentOrParents=[n,this]}else{if(-1!==n.indexOf(this))return t;n.push(this)}var i=this._subscriptions;return null===i?this._subscriptions=[t]:i.push(t),t},Subscription.prototype.remove=function(e){var t=this._subscriptions;if(t){var r=t.indexOf(e);-1!==r&&t.splice(r,1)}},Subscription.EMPTY=function(e){return e.closed=!0,e}(new Subscription),Subscription}();function flattenUnsubscriptionErrors(e){return e.reduce((function(e,t){return e.concat(t instanceof T?t.errors:t)}),[])}var N=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),I=function(e){function Subscriber(t,r,n){var i=e.call(this)||this;switch(i.syncErrorValue=null,i.syncErrorThrown=!1,i.syncErrorThrowable=!1,i.isStopped=!1,arguments.length){case 0:i.destination=O;break;case 1:if(!t){i.destination=O;break}if("object"==typeof t){t instanceof Subscriber?(i.syncErrorThrowable=t.syncErrorThrowable,i.destination=t,t.add(i)):(i.syncErrorThrowable=!0,i.destination=new R(i,t));break}default:i.syncErrorThrowable=!0,i.destination=new R(i,t,r,n)}return i}return __extends(Subscriber,e),Subscriber.prototype[N]=function(){return this},Subscriber.create=function(e,t,r){var n=new Subscriber(e,t,r);return n.syncErrorThrowable=!1,n},Subscriber.prototype.next=function(e){this.isStopped||this._next(e)},Subscriber.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},Subscriber.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},Subscriber.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this))},Subscriber.prototype._next=function(e){this.destination.next(e)},Subscriber.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},Subscriber.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},Subscriber.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},Subscriber}(j),R=function(e){function SafeSubscriber(t,r,n,i){var o,s=e.call(this)||this;s._parentSubscriber=t;var c=s;return isFunction(r)?o=r:r&&(o=r.next,n=r.error,i=r.complete,r!==O&&(isFunction((c=Object.create(r)).unsubscribe)&&s.add(c.unsubscribe.bind(c)),c.unsubscribe=s.unsubscribe.bind(s))),s._context=c,s._next=o,s._error=n,s._complete=i,s}return __extends(SafeSubscriber,e),SafeSubscriber.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;x.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},SafeSubscriber.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,r=x.useDeprecatedSynchronousErrorHandling;if(this._error)r&&t.syncErrorThrowable?(this.__tryOrSetError(t,this._error,e),this.unsubscribe()):(this.__tryOrUnsub(this._error,e),this.unsubscribe());else if(t.syncErrorThrowable)r?(t.syncErrorValue=e,t.syncErrorThrown=!0):hostReportError(e),this.unsubscribe();else{if(this.unsubscribe(),r)throw e;hostReportError(e)}}},SafeSubscriber.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var wrappedComplete=function(){return e._complete.call(e._context)};x.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?(this.__tryOrSetError(t,wrappedComplete),this.unsubscribe()):(this.__tryOrUnsub(wrappedComplete),this.unsubscribe())}else this.unsubscribe()}},SafeSubscriber.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),x.useDeprecatedSynchronousErrorHandling)throw e;hostReportError(e)}},SafeSubscriber.prototype.__tryOrSetError=function(e,t,r){if(!x.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{t.call(this._context,r)}catch(t){return x.useDeprecatedSynchronousErrorHandling?(e.syncErrorValue=t,e.syncErrorThrown=!0,!0):(hostReportError(t),!0)}return!1},SafeSubscriber.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},SafeSubscriber}(I);var k=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function identity(e){return e}function pipeFromArray(e){return 0===e.length?identity:1===e.length?e[0]:function piped(t){return e.reduce((function(e,t){return t(e)}),t)}}var M=function(){function Observable(e){this._isScalar=!1,e&&(this._subscribe=e)}return Observable.prototype.lift=function(e){var t=new Observable;return t.source=this,t.operator=e,t},Observable.prototype.subscribe=function(e,t,r){var n=this.operator,i=function toSubscriber(e,t,r){if(e){if(e instanceof I)return e;if(e[N])return e[N]()}return e||t||r?new I(e,t,r):new I(O)}(e,t,r);if(n?i.add(n.call(i,this.source)):i.add(this.source||x.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),x.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},Observable.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){x.useDeprecatedSynchronousErrorHandling&&(e.syncErrorThrown=!0,e.syncErrorValue=t),!function canReportError(e){for(;e;){var t=e,r=t.closed,n=t.destination,i=t.isStopped;if(r||i)return!1;e=n&&n instanceof I?n:null}return!0}(e)?console.warn(t):e.error(t)}},Observable.prototype.forEach=function(e,t){var r=this;return new(t=getPromiseCtor(t))((function(t,n){var i;i=r.subscribe((function(t){try{e(t)}catch(e){n(e),i&&i.unsubscribe()}}),n,t)}))},Observable.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},Observable.prototype[k]=function(){return this},Observable.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this:pipeFromArray(e)(this)},Observable.prototype.toPromise=function(e){var t=this;return new(e=getPromiseCtor(e))((function(e,r){var n;t.subscribe((function(e){return n=e}),(function(e){return r(e)}),(function(){return e(n)}))}))},Observable.create=function(e){return new Observable(e)},Observable}();function getPromiseCtor(e){if(e||(e=Promise),!e)throw new Error("no Promise impl found");return e}var P=function(){function ObjectUnsubscribedErrorImpl(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return ObjectUnsubscribedErrorImpl.prototype=Object.create(Error.prototype),ObjectUnsubscribedErrorImpl}(),C=function(e){function SubjectSubscription(t,r){var n=e.call(this)||this;return n.subject=t,n.subscriber=r,n.closed=!1,n}return __extends(SubjectSubscription,e),SubjectSubscription.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var e=this.subject,t=e.observers;if(this.subject=null,t&&0!==t.length&&!e.isStopped&&!e.closed){var r=t.indexOf(this.subscriber);-1!==r&&t.splice(r,1)}}},SubjectSubscription}(j),D=function(e){function SubjectSubscriber(t){var r=e.call(this,t)||this;return r.destination=t,r}return __extends(SubjectSubscriber,e),SubjectSubscriber}(I),W=function(e){function Subject(){var t=e.call(this)||this;return t.observers=[],t.closed=!1,t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return __extends(Subject,e),Subject.prototype[N]=function(){return new D(this)},Subject.prototype.lift=function(e){var t=new U(this,this);return t.operator=e,t},Subject.prototype.next=function(e){if(this.closed)throw new P;if(!this.isStopped)for(var t=this.observers,r=t.length,n=t.slice(),i=0;i<r;i++)n[i].next(e)},Subject.prototype.error=function(e){if(this.closed)throw new P;this.hasError=!0,this.thrownError=e,this.isStopped=!0;for(var t=this.observers,r=t.length,n=t.slice(),i=0;i<r;i++)n[i].error(e);this.observers.length=0},Subject.prototype.complete=function(){if(this.closed)throw new P;this.isStopped=!0;for(var e=this.observers,t=e.length,r=e.slice(),n=0;n<t;n++)r[n].complete();this.observers.length=0},Subject.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},Subject.prototype._trySubscribe=function(t){if(this.closed)throw new P;return e.prototype._trySubscribe.call(this,t)},Subject.prototype._subscribe=function(e){if(this.closed)throw new P;return this.hasError?(e.error(this.thrownError),j.EMPTY):this.isStopped?(e.complete(),j.EMPTY):(this.observers.push(e),new C(this,e))},Subject.prototype.asObservable=function(){var e=new M;return e.source=this,e},Subject.create=function(e,t){return new U(e,t)},Subject}(M),U=function(e){function AnonymousSubject(t,r){var n=e.call(this)||this;return n.destination=t,n.source=r,n}return __extends(AnonymousSubject,e),AnonymousSubject.prototype.next=function(e){var t=this.destination;t&&t.next&&t.next(e)},AnonymousSubject.prototype.error=function(e){var t=this.destination;t&&t.error&&this.destination.error(e)},AnonymousSubject.prototype.complete=function(){var e=this.destination;e&&e.complete&&this.destination.complete()},AnonymousSubject.prototype._subscribe=function(e){return this.source?this.source.subscribe(e):j.EMPTY},AnonymousSubject}(W),G=function(e){function QueueAction(t,r){var n=e.call(this,t,r)||this;return n.scheduler=t,n.work=r,n}return __extends(QueueAction,e),QueueAction.prototype.schedule=function(t,r){return void 0===r&&(r=0),r>0?e.prototype.schedule.call(this,t,r):(this.delay=r,this.state=t,this.scheduler.flush(this),this)},QueueAction.prototype.execute=function(t,r){return r>0||this.closed?e.prototype.execute.call(this,t,r):this._execute(t,r)},QueueAction.prototype.requestAsyncId=function(t,r,n){return void 0===n&&(n=0),null!==n&&n>0||null===n&&this.delay>0?e.prototype.requestAsyncId.call(this,t,r,n):t.flush(this)},QueueAction}(function(e){function AsyncAction(t,r){var n=e.call(this,t,r)||this;return n.scheduler=t,n.work=r,n.pending=!1,n}return __extends(AsyncAction,e),AsyncAction.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var r=this.id,n=this.scheduler;return null!=r&&(this.id=this.recycleAsyncId(n,r,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(n,this.id,t),this},AsyncAction.prototype.requestAsyncId=function(e,t,r){return void 0===r&&(r=0),setInterval(e.flush.bind(e,this),r)},AsyncAction.prototype.recycleAsyncId=function(e,t,r){if(void 0===r&&(r=0),null!==r&&this.delay===r&&!1===this.pending)return t;clearInterval(t)},AsyncAction.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(e,t);if(r)return r;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},AsyncAction.prototype._execute=function(e,t){var r=!1,n=void 0;try{this.work(e)}catch(e){r=!0,n=!!e&&e||new Error(e)}if(r)return this.unsubscribe(),n},AsyncAction.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,r=t.actions,n=r.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==n&&r.splice(n,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},AsyncAction}(function(e){function Action(t,r){return e.call(this)||this}return __extends(Action,e),Action.prototype.schedule=function(e,t){return this},Action}(j))),H=function(){function Scheduler(e,t){void 0===t&&(t=Scheduler.now),this.SchedulerAction=e,this.now=t}return Scheduler.prototype.schedule=function(e,t,r){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(r,t)},Scheduler.now=function(){return Date.now()},Scheduler}(),V=new(function(e){function QueueScheduler(){return null!==e&&e.apply(this,arguments)||this}return __extends(QueueScheduler,e),QueueScheduler}(function(e){function AsyncScheduler(t,r){void 0===r&&(r=H.now);var n=e.call(this,t,(function(){return AsyncScheduler.delegate&&AsyncScheduler.delegate!==n?AsyncScheduler.delegate.now():r()}))||this;return n.actions=[],n.active=!1,n.scheduled=void 0,n}return __extends(AsyncScheduler,e),AsyncScheduler.prototype.schedule=function(t,r,n){return void 0===r&&(r=0),AsyncScheduler.delegate&&AsyncScheduler.delegate!==this?AsyncScheduler.delegate.schedule(t,r,n):e.prototype.schedule.call(this,t,r,n)},AsyncScheduler.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var r;this.active=!0;do{if(r=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,r){for(;e=t.shift();)e.unsubscribe();throw r}}},AsyncScheduler}(H)))(G),K=new M((function(e){return e.complete()}));function empty$1(e){return e?function emptyScheduled(e){return new M((function(t){return e.schedule((function(){return t.complete()}))}))}(e):K}function isScheduler(e){return e&&"function"==typeof e.schedule}function scheduleArray(e,t){return new M((function(r){var n=new j,i=0;return n.add(t.schedule((function(){i!==e.length?(r.next(e[i++]),r.closed||n.add(this.schedule())):r.complete()}))),n}))}function fromArray(e,t){return t?scheduleArray(e,t):new M((r=e,function(e){for(var t=0,n=r.length;t<n&&!e.closed;t++)e.next(r[t]);e.complete()}));var r}function dispatch(e){var t=e.error;e.subscriber.error(t)}var F=function(){function Notification(e,t,r){this.kind=e,this.value=t,this.error=r,this.hasValue="N"===e}return Notification.prototype.observe=function(e){switch(this.kind){case"N":return e.next&&e.next(this.value);case"E":return e.error&&e.error(this.error);case"C":return e.complete&&e.complete()}},Notification.prototype.do=function(e,t,r){switch(this.kind){case"N":return e&&e(this.value);case"E":return t&&t(this.error);case"C":return r&&r()}},Notification.prototype.accept=function(e,t,r){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,r)},Notification.prototype.toObservable=function(){switch(this.kind){case"N":return function of(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[e.length-1];return isScheduler(r)?(e.pop(),scheduleArray(e,r)):fromArray(e)}(this.value);case"E":return function throwError(e,t){return new M(t?function(r){return t.schedule(dispatch,0,{error:e,subscriber:r})}:function(t){return t.error(e)})}(this.error);case"C":return empty$1()}throw new Error("unexpected notification kind value")},Notification.createNext=function(e){return void 0!==e?new Notification("N",e):Notification.undefinedValueNotification},Notification.createError=function(e){return new Notification("E",void 0,e)},Notification.createComplete=function(){return Notification.completeNotification},Notification.completeNotification=new Notification("C"),Notification.undefinedValueNotification=new Notification("N",void 0),Notification}(),$=function(e){function ObserveOnSubscriber(t,r,n){void 0===n&&(n=0);var i=e.call(this,t)||this;return i.scheduler=r,i.delay=n,i}return __extends(ObserveOnSubscriber,e),ObserveOnSubscriber.dispatch=function(e){var t=e.notification,r=e.destination;t.observe(r),this.unsubscribe()},ObserveOnSubscriber.prototype.scheduleMessage=function(e){this.destination.add(this.scheduler.schedule(ObserveOnSubscriber.dispatch,this.delay,new Q(e,this.destination)))},ObserveOnSubscriber.prototype._next=function(e){this.scheduleMessage(F.createNext(e))},ObserveOnSubscriber.prototype._error=function(e){this.scheduleMessage(F.createError(e)),this.unsubscribe()},ObserveOnSubscriber.prototype._complete=function(){this.scheduleMessage(F.createComplete()),this.unsubscribe()},ObserveOnSubscriber}(I),Q=function(){return function ObserveOnMessage(e,t){this.notification=e,this.destination=t}}(),Y=function(e){function ReplaySubject(t,r,n){void 0===t&&(t=Number.POSITIVE_INFINITY),void 0===r&&(r=Number.POSITIVE_INFINITY);var i=e.call(this)||this;return i.scheduler=n,i._events=[],i._infiniteTimeWindow=!1,i._bufferSize=t<1?1:t,i._windowTime=r<1?1:r,r===Number.POSITIVE_INFINITY?(i._infiniteTimeWindow=!0,i.next=i.nextInfiniteTimeWindow):i.next=i.nextTimeWindow,i}return __extends(ReplaySubject,e),ReplaySubject.prototype.nextInfiniteTimeWindow=function(t){if(!this.isStopped){var r=this._events;r.push(t),r.length>this._bufferSize&&r.shift()}e.prototype.next.call(this,t)},ReplaySubject.prototype.nextTimeWindow=function(t){this.isStopped||(this._events.push(new q(this._getNow(),t)),this._trimBufferThenGetEvents()),e.prototype.next.call(this,t)},ReplaySubject.prototype._subscribe=function(e){var t,r=this._infiniteTimeWindow,n=r?this._events:this._trimBufferThenGetEvents(),i=this.scheduler,o=n.length;if(this.closed)throw new P;if(this.isStopped||this.hasError?t=j.EMPTY:(this.observers.push(e),t=new C(this,e)),i&&e.add(e=new $(e,i)),r)for(var s=0;s<o&&!e.closed;s++)e.next(n[s]);else for(s=0;s<o&&!e.closed;s++)e.next(n[s].value);return this.hasError?e.error(this.thrownError):this.isStopped&&e.complete(),t},ReplaySubject.prototype._getNow=function(){return(this.scheduler||V).now()},ReplaySubject.prototype._trimBufferThenGetEvents=function(){for(var e=this._getNow(),t=this._bufferSize,r=this._windowTime,n=this._events,i=n.length,o=0;o<i&&!(e-n[o].time<r);)o++;return i>t&&(o=Math.max(o,i-t)),o>0&&n.splice(0,o),n},ReplaySubject}(W),q=function(){return function ReplayEvent(e,t){this.time=e,this.value=t}}();let z=class WebviewService{constructor(e,r){this.loggerService=e,this.eventService=r,this.routeToEventName=t.resolve("alt.webview.routeTo.eventName"),this.cursorCount=0,this.events=[],this.webviewReadySubject$=new Y,this.webviewToServerEventName=l.EventService.GuiEmitServer,this.url=t.resolve("alt.webview.url"),this.createInstance()}add(e,t,r){const n=(new WebviewEventModel).cast({eventName:e,targetName:t,methodName:r});this.events.push(n)}getWebView(){return this.webview}routeTo(e,...t){return this.webview.emit(this.routeToEventName,e,...t),this}showCursor(){return c(!0),this.cursorCount=this.cursorCount+1,this}removeCursor(){return this.cursorCount>0&&(c(!1),this.cursorCount=this.cursorCount-1),this}removeAllCursors(){for(let e=0;e<this.cursorCount;e++)c(!1);return this.cursorCount=0,this}start(){this.events.forEach((e=>{const r=t.resolve(e.targetName),n=r[e.methodName].bind(r);this.webview.on(e.eventName,n)}))}autoStart(e){y.log("Starting ~y~WebviewService~w~"),this.initialize().subscribe((()=>{y.log("Started ~lg~WebviewService~w~"),e()}))}emit(e,...t){return this.webview.emit(e,...t),this}on(e,t){this.webview.on(e,t)}destroy(){this.webview.destroy()}focus(){return this.webview.focus(),this}unfocus(){return this.webview.unfocus(),this}initialize(){return this.webviewReadySubject$}createInstance(){this.webview=new u(this.url,!1),this.listenReadyEvent(),this.sendEventToServer(),this.listenGuiOnEvent(),this.listenToServerSendGuiEvent()}listenReadyEvent(){this.webview.on("load",(()=>{this.webviewReadySubject$.next(!0),this.webviewReadySubject$.complete()}))}sendEventToServer(){this.webview.on(this.webviewToServerEventName,((e,...t)=>{this.eventService.emitServer(e,...t)}))}listenGuiOnEvent(){this.eventService.on(l.EventService.GuiOn,((e,t)=>{this.webview.on(e,t)}))}listenToServerSendGuiEvent(){this.eventService.onServer(l.EventService.ServerEmitGui,((e,...t)=>{y.nextTick((()=>{this.webview.emit(e,...t)}))}))}};z=__decorate([b,e(),__metadata("design:paramtypes",[v,E])],z);class KeyEventModel extends f{}__decorate([p({from:d()}),__metadata("design:type",String)],KeyEventModel.prototype,"target",void 0),__decorate([p({from:d()}),__metadata("design:type",String)],KeyEventModel.prototype,"methodName",void 0),__decorate([p({from:d()}),__metadata("design:type",String)],KeyEventModel.prototype,"type",void 0),__decorate([p({from:S()}),__metadata("design:type",Number)],KeyEventModel.prototype,"key",void 0);let B=class KeyEventService{constructor(e){this.eventService=e,this.events=new Map}start(){this.eventTypeExist("keyup")&&this.eventService.on("keyup",this.keyup.bind(this)),this.eventTypeExist("keydown")&&this.eventService.on("keydown",this.keydown.bind(this))}autoStart(e){(this.eventTypeExist("keyup")||this.eventTypeExist("keydown"))&&(y.log("Starting ~y~KeyEventService Decorator~w~"),this.start(),y.log("Started ~lg~KeyEventService Decorator~w~")),e()}add(e,t,r,n){const i=`${e}_${t}`;if(this.events.has(i))return;const o=(new KeyEventModel).cast({key:t,type:e,target:r,methodName:n});this.events.set(i,o)}run(e){const r=this.events.get(e);if(r){t.resolveAll(r.target).forEach((async e=>{if(e[r.methodName]){const t=e[r.methodName].bind(e);await t()}}))}}eventTypeExist(e){return!!Array.from(this.events.values()).filter((t=>t.type===e)).length}keyup(e){this.run(`keyup_${e}`)}keydown(e){this.run(`keydown_${e}`)}};B=__decorate([b,e(),__metadata("design:paramtypes",[E])],B);let J=class PlayerWorker{constructor(e){this.eventService=e,this.handleRealTime()}handleRealTime(){this.eventService.onServer(l.Player.SetRealTime,(e=>{a(e)}))}};J=__decorate([e(),__metadata("design:paramtypes",[E])],J),t.resolve(J);const L=t.resolve(w);t.register("EventService",{useValue:t.resolve(E)}),t.afterResolution(B,(()=>{L.add("afterBootstrap","autoStart","KeyEventService")}),{frequency:"Once"}),t.afterResolution(z,(()=>{L.add("before","autoStart","WebviewService")}),{frequency:"Once"});const OnServer=e=>(t,r,n)=>{const i=e||r,o=(new _).cast({name:i});return m(t,"onServer",r,n,o)},OnceServer=e=>(t,r,n)=>{const i=e||r,o=(new _).cast({name:i});return m(t,"onceServer",r,n,o)},OnGui=e=>(t,r,n)=>{const i=e||r,o=(new _).cast({name:i});return m(t,"onGui",r,n,o)},GameEntityCreate=e=>(t,r,n)=>{const i=(new _).cast({entity:e,eventAddTo:"gameEntity"});return m(t,"gameEntityCreate",r,n,i)},GameEntityDestroy=e=>(t,r,n)=>{const i=(new _).cast({entity:e,eventAddTo:"gameEntity"});return m(t,"gameEntityDestroy",r,n,i)},StreamSyncedMetaChange=(e,t)=>(r,n,i)=>{const o=(new _).cast({entity:e,metaKey:t,eventAddTo:"metaChange"});return m(r,"streamSyncedMetaChange",n,i,o)},SyncedMetaChange=(e,t)=>(r,n,i)=>{const o=(new _).cast({entity:e,metaKey:t,eventAddTo:"metaChange"});return m(r,"syncedMetaChange",n,i,o)},KeyUp=e=>createDecorator(e,"keyup"),KeyDown=e=>createDecorator(e,"keydown");function createDecorator(e,r){return(n,i,o)=>{const s=t.resolve(B),c=o.value;return o.value=function(...e){return c.apply(this,e)},e="string"==typeof e?e.charCodeAt(0):e,s.add(r,e,n.constructor.name,i),o}}u.prototype.routeTo=(e,...r)=>{t.resolve(z).routeTo(e,...r)};export{E as EventService,GameEntityCreate,GameEntityDestroy,KeyDown,B as KeyEventService,KeyUp,OnGui,OnServer,OnceServer,StreamSyncedMetaChange,SyncedMetaChange,z as WebviewService};
